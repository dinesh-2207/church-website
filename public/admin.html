<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - FGM</title>
    <style>
        /* --- 1. Basic Setup & Fonts --- */
        :root {
            --theme-primary: #000604;
            --theme-secondary: #f39c12;
            --theme-dark: #2c3e50;
            --text-dark: #2c3e50;
            --text-light: #555;
            --bg-light: #f4f6f9; /* Admin background is slightly different */
            --bg-white: #ffffff;
            --sidebar-width: 260px;
        }

        body, html {
            margin: 0; padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-light);
            color: var(--text-dark);
            overflow: hidden; /* No scroll on main body */
        }
        
        .admin-container {
            display: flex;
            height: 100vh;
        }

        /* --- 2. Sidebar --- */
        .admin-sidebar {
            width: var(--sidebar-width);
            background: var(--theme-dark);
            color: #eee;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 100;
        }
        .admin-sidebar .logo {
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            color: var(--bg-white);
            text-transform: uppercase;
            padding: 10px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #4a5a6a;
        }
        .admin-sidebar .logo img {
            height: 40px;
            margin-right: 10px;
        }
        .admin-sidebar .nav-title {
            font-size: 12px;
            font-weight: 600;
            color: #9aabbc;
            text-transform: uppercase;
            margin: 20px 0 10px 0;
        }
        .admin-sidebar .sidebar-link {
            display: block;
            padding: 12px 15px;
            text-decoration: none;
            color: #e0e0e0;
            font-size: 15px;
            font-weight: 500;
            border-radius: 8px;
            margin-bottom: 5px;
            transition: all 0.2s;
            cursor: pointer;
        }
        .admin-sidebar .sidebar-link:hover {
            background-color: #4a5a6a;
        }
        .admin-sidebar .sidebar-link.active {
            background-color: var(--theme-secondary);
            color: var(--bg-white);
            font-weight: 600;
        }
        .admin-sidebar .logout {
            margin-top: auto;
        }

        /* --- 3. Main Content --- */
        .admin-main-content {
            flex: 1;
            height: 100vh;
            overflow-y: auto;
            padding: 30px;
            box-sizing: border-box;
            scroll-behavior: smooth;
        }
        .admin-page {
            display: none;
        }
        .admin-page.active {
            display: block;
        }
        
        .admin-page h1 {
            font-size: 32px;
            font-weight: 800;
            color: var(--theme-primary);
            margin: 0 0 30px 0;
        }

        /* --- 4. Cards & Forms --- */
        .admin-card {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
            padding: 30px;
            margin-bottom: 30px;
        }
        .admin-card h2 {
            font-size: 22px;
            color: var(--theme-primary);
            margin: 0 0 20px 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 15px;
        }
        .admin-card.editing {
            border: 2px solid var(--theme-secondary);
            background: #fffdf9;
        }

        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Inter', sans-serif;
            box-sizing: border-box;
        }
        .form-group textarea { min-height: 100px; }
        
        .preview-img {
            max-width: 150px;
            height: auto;
            display: none;
            margin-top: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .btn-primary {
            background-color: var(--theme-primary);
            color: white;
            padding: 14px 30px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary:hover { background-color: #004a35; }
        
        .btn-secondary {
            background-color: var(--theme-secondary);
            color: white;
        }
        .btn-secondary:hover { background-color: #e67e22; }

        .btn-danger {
            background-color: #d9534f;
            color: white;
        }
        .btn-danger:hover { background-color: #c9302c; }

        .btn-light {
            background-color: #f4f4f4;
            color: #333;
            border: 1px solid #ccc;
            padding: 14px 30px;
            border-radius: 30px;
            font-weight: bold;
            cursor: pointer;
        }
        .btn-light:hover { background-color: #e0e0e0; }

        .cancel-edit-btn {
            display: none;
            margin-left: 10px;
        }

        /* --- 5. Current Items List --- */
        .current-item-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .current-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        .current-item .item-info {
            display: flex;
            align-items: center;
            gap: 15px;
            min-width: 0;
            flex: 1;
        }
        .current-item .item-info img {
            width: 80px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
            flex-shrink: 0;
        }
        .current-item .item-info div {
            min-width: 0;
            flex: 1;
        }
        .current-item .item-info h3 {
            font-size: 16px;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .current-item .item-info p {
            font-size: 14px;
            color: var(--text-light);
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .current-item .item-actions {
            display: flex;
            gap: 5px;
            flex-shrink: 0;
        }
        .current-item .item-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            font-size: 16px;
            line-height: 1;
            transition: background-color 0.2s;
        }
        .btn-delete { color: #d9534f; }
        .btn-delete:hover { background-color: #fce8e6; }
        .btn-edit { color: var(--theme-secondary); }
        .btn-edit:hover { background-color: #fef5e7; }

    </style>
</head>
<body>
    <div class="admin-container">
        
        <aside class="admin-sidebar">
            <div class="logo">
                <img src="logo.png" alt="Logo">
                FGM Admin
            </div>
            
            <a class="sidebar-link active" data-page="dashboard">Dashboard</a>
            
            <div class="nav-title">Manage Content</div>
            <a class="sidebar-link" data-page="manage-events">Events</a>
            <a class="sidebar-link" data-page="manage-locations">Locations</a>
            <a class="sidebar-link" data-page="manage-ministries">Ministries</a>
            <a class="sidebar-link" data-page="manage-gallery">Gallery</a>
            <a class="sidebar-link" data-page="manage-about">About Page</a>

            <div class="nav-title">Settings</div>
            <a class="sidebar-link" href="#" id="logout-sidebar-link">Logout</a>
        </aside>

        <main class="admin-main-content">

            <section class="admin-page active" id="dashboard">
                <h1>Dashboard</h1>
                <div class="admin-card">
                    <h2>Welcome, Admin!</h2>
                    <p>From here you can manage all the content on the Full Gospel Ministries website.</p>
                </div>
            </section>

            <section class="admin-page" id="manage-events">
                <h1>Manage Events</h1>
                <div class="admin-card" id="card-event-form">
                    <h2 id="event-form-title">Add New Event</h2>
                    <form id="form-add-event">
                        <input type="hidden" name="id" id="event-id">
                        <div class="form-group">
                            <label for="event-title">Event Title</label>
                            <input type="text" id="event-title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="event-subtitle">Event Subtitle (Date & Time)</label>
                            <input type="text" id="event-subtitle" name="subtitle" placeholder="e.g., October 26, 2025 @ 5:00 PM">
                        </div>
                        <div class="form-group">
                            <label for="event-description">Short Description (for card)</label>
                            <textarea id="event-description" name="description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="event-image">Grid Image (for card)</label>
                            <img src="" id="event-image-preview" class="preview-img" alt="Preview">
                            <input type="file" id="event-image" name="image" accept="image/*">
                        </div>

                        <hr style="margin: 30px 0;">
                        <h3>Event Detail Page Info</h3>
                        <div class="form-group">
                            <label for="event-fullDescription">Full Event Details</label>
                            <textarea id="event-fullDescription" name="fullDescription"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="event-registrationNote">Registration Note</label>
                            <input type="text" id="event-registrationNote" name="registrationNote">
                        </div>
                        <div class="form-group">
                            <label for="event-detail-image">Detail Page Image (Optional)</label>
                            <img src="" id="event-detail-image-preview" class="preview-img" alt="Preview">
                            <input type="file" id="event-detail-image" name="detailImage" accept="image/*">
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="event-submit-btn" class="btn-primary btn-secondary">Save New Event</button>
                            <button type="button" class="btn-light cancel-edit-btn" onclick="resetForm('event')">Cancel Edit</button>
                        </div>
                    </form>
                </div>
                <div class="admin-card">
                    <h2>Current Events</h2>
                    <div class="current-item-list" id="events-list"></div>
                </div>
            </section>
            
            <section class="admin-page" id="manage-locations">
                <h1>Manage Locations</h1>
                <div class="admin-card" id="card-location-form">
                    <h2 id="location-form-title">Add New Location</h2>
                    <form id="form-add-location">
                        <input type="hidden" name="id" id="location-id">
                        <div class="form-group">
                            <label for="loc-title">Campus Name (Title)</label>
                            <input type="text" id="loc-title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="loc-subtitle">Service Times (Subtitle)</label>
                            <input type="text" id="loc-subtitle" name="subtitle">
                        </div>
                        <div class="form-group">
                            <label for="loc-description">Short Description (for card)</label>
                            <textarea id="loc-description" name="description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="loc-image">Grid Image</label>
                            <img src="" id="location-image-preview" class="preview-img" alt="Preview">
                            <input type="file" id="loc-image" name="image" accept="image/*">
                        </div>

                        <hr style="margin: 30px 0;">
                        <h3>Location Detail Page Info</h3>
                        <div class="form-group">
                            <label for="loc-pastorName">Pastor Name</label>
                            <input type="text" id="loc-pastorName" name="pastorName">
                        </div>
                        <div class="form-group">
                            <label for="loc-detail-image">Detail Page Image</label>
                            <img src="" id="location-detail-image-preview" class="preview-img" alt="Preview">
                            <input type="file" id="loc-detail-image" name="detailImage" accept="image/*">
                        </div>
                        <div class="form-group">
                            <label for="loc-phone">Phone</label>
                            <input type="text" id="loc-phone" name="phone">
                        </div>
                        <div class="form-group">
                            <label for="loc-email">Email</label>
                            <input type="email" id="loc-email" name="email">
                        </div>
                        <div class="form-group">
                            <label for="loc-address">Address</label>
                            <textarea id="loc-address" name="address"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="loc-mailingAddress">Mailing Address</label>
                            <textarea id="loc-mailingAddress" name="mailingAddress"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="loc-googleMapEmbed">Google Map Embed Code</label>
                            <textarea id="loc-googleMapEmbed" name="googleMapEmbed"></textarea>
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="location-submit-btn" class="btn-primary btn-secondary">Save New Location</button>
                            <button type="button" class="btn-light cancel-edit-btn" onclick="resetForm('location')">Cancel Edit</button>
                        </div>
                    </form>
                </div>
                <div class="admin-card">
                    <h2>Current Locations</h2>
                    <div class="current-item-list" id="locations-list"></div>
                </div>
            </section>

            <section class="admin-page" id="manage-ministries">
                <h1>Manage Ministries</h1>
                <div class="admin-card" id="card-ministry-form">
                    <h2 id="ministry-form-title">Add New Ministry</h2>
                    <form id="form-add-ministry">
                        <input type="hidden" name="id" id="ministry-id">
                        <div class="form-group">
                            <label for="min-title">Ministry Title</label>
                            <input type="text" id="min-title" name="title" required>
                        </div>
                        <div class="form-group">
                            <label for="min-subtitle">Ministry Subtitle</label>
                            <input type="text" id="min-subtitle" name="subtitle">
                        </div>
                        <div class="form-group">
                            <label for="min-description">Short Description (for card)</label>
                            <textarea id="min-description" name="description"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="min-image">Grid Image</label>
                            <img src="" id="ministry-image-preview" class="preview-img" alt="Preview">
                            <input type="file" id="min-image" name="image" accept="image/*">
                        </div>

                        <hr style="margin: 30px 0;">
                        <h3>Ministry Detail Page Info</h3>
                        <div class="form-group">
                            <label for="min-fullDescription">Full Ministry Details</label>
                            <textarea id="min-fullDescription" name="fullDescription"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="min-detail-image">Detail Page Image (Optional)</label>
                            <img src="" id="ministry-detail-image-preview" class="preview-img" alt="Preview">
                            <input type="file" id="min-detail-image" name="detailImage" accept="image/*">
                        </div>

                        <div class="form-actions">
                            <button type="submit" id="ministry-submit-btn" class="btn-primary btn-secondary">Save New Ministry</button>
                            <button type="button" class="btn-light cancel-edit-btn" onclick="resetForm('ministry')">Cancel Edit</button>
                        </div>
                    </form>
                </div>
                <div class="admin-card">
                    <h2>Current Ministries</h2>
                    <div class="current-item-list" id="ministries-list"></div>
                </div>
            </section>
            
            <section class="admin-page" id="manage-gallery">
                <h1>Manage Gallery</h1>
                <div class="admin-card">
                    <h2>Add New Photo</h2>
                    <form id="form-add-photo">
                        <div class="form-group">
                            <label for="photo-image">Image Upload</label>
                            <input type="file" id="photo-image" name="image" accept="image/*" required>
                        </div>
                        <div class="form-group">
                            <label for="photo-category">Category</label>
                            <select id="photo-category" name="category">
                                <option value="social">Social Work</option>
                                <option value="events">Events</option>
                                <option value="pastors">Pastors</option>
                                <option value="functions">Functions</option>
                            </select>
                        </div>
                        <button type="submit" class="btn-primary btn-secondary">Add Photo to Gallery</button>
                    </form>
                </div>
                <div class="admin-card">
                    <h2>Current Photos</h2>
                    <div class="current-item-list" id="gallery-list"></div>
                </div>
            </section>
            
            <section class="admin-page" id="manage-about">
                <h1>Manage About Page</h1>
                <div class="admin-card">
                    <h2>Edit Page Content</h2>
                    <form id="form-manage-about">
                        <div class="form-group">
                            <label for="about-mission">Our Mission</label>
                            <textarea id="about-mission" name="ourMission" style="min-height: 150px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="about-story">Our Story</label>
                            <textarea id="about-story" name="ourStory" style="min-height: 250px;"></textarea>
                        </div>
                        <hr style="margin: 30px 0;">
                        <h3>About Page Image</h3>
                        <div class="form-group">
                            <label>Current Image</label>
                            <img src="" id="about-image-preview" class="preview-img" style="max-width: 200px;">
                        </div>
                        <div class="form-group">
                            <label for="about-image-file">Upload New Image (Optional)</label>
                            <input type="file" id="about-image-file" name="image" accept="image/*">
                        </div>
                        <button type="submit" class="btn-primary btn-secondary">Save About Content</button>
                    </form>
                </div>
            </section>

        </main>
    </div>

    <script>
    // Safe redirection helper to avoid SyntaxError in blob contexts
    function redirectToLogin() {
        try {
            window.location.href = 'admin-login.html';
        } catch (e) {
            console.warn("Redirection failed. Please navigate to login page manually.");
            alert("Please log in to continue.");
        }
    }

    // --- HELPER TO RESET FORMS ---
    function resetForm(type) {
        const form = document.getElementById(`form-add-${type}`);
        const card = document.getElementById(`card-${type}-form`);
        const title = document.getElementById(`${type}-form-title`);
        const btn = document.getElementById(`${type}-submit-btn`);
        const cancelBtn = card.querySelector('.cancel-edit-btn');
        const previews = card.querySelectorAll('.preview-img');

        form.reset();
        document.getElementById(`${type}-id`).value = "";
        card.classList.remove('editing');
        title.textContent = `Add New ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        btn.textContent = `Save New ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        cancelBtn.style.display = "none";
        previews.forEach(img => {
            img.src = "";
            img.style.display = "none";
        });
    }

    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token'); 
        if (!token) {
            console.warn('Authentication token missing.');
            // redirectToLogin(); // Commented out to prevent crash in preview environments
        }
        
        const links = document.querySelectorAll('.sidebar-link');
        const pages = document.querySelectorAll('.admin-page');
        const mainContent = document.querySelector('.admin-main-content');

        // --- Page Switching ---
        links.forEach(link => {
            link.addEventListener('click', (e) => {
                if (link.getAttribute('data-page')) e.preventDefault();
                const pageId = link.getAttribute('data-page');
                if (!pageId) return; 
                pages.forEach(page => page.classList.toggle('active', page.id === pageId));
                links.forEach(l => l.classList.toggle('active', l.getAttribute('data-page') === pageId));
            });
        });

        const logoutLink = document.getElementById('logout-sidebar-link');
        if (logoutLink) {
            logoutLink.addEventListener('click', (e) => {
                e.preventDefault(); 
                localStorage.removeItem('token');
                redirectToLogin();
            });
        }

        // --- API Helpers ---
        async function sendFormData(endpoint, formData, method = 'POST') {
            try {
                const res = await fetch(endpoint, {
                    method: method,
                    headers: { "Authorization": `Bearer ${token}` },
                    body: formData
                });
                const result = await res.json();
                
                if (res.ok) {
                    alert(`Success! Data has been ${method === 'POST' ? 'added' : 'updated'}.`);
                    
                    const cleanEndpoint = endpoint.split('/')[2]; // gets 'locations' from '/api/locations'
                    if (cleanEndpoint === 'locations') loadDynamicData('locations', 'locations-list', renderListItem);
                    else if (cleanEndpoint === 'events') loadDynamicData('events', 'events-list', renderListItem);
                    else if (cleanEndpoint === 'ministries') loadDynamicData('ministries', 'ministries-list', renderListItem);
                    else if (cleanEndpoint === 'gallery') loadDynamicData('gallery', 'gallery-list', renderGalleryItem);
                    else if (cleanEndpoint === 'about') loadAboutData();

                    // If it was an edit, reset the form back to Add mode
                    if (method === 'PUT') {
                        const type = cleanEndpoint === 'ministries' ? 'ministry' : cleanEndpoint.slice(0, -1);
                        if (['event', 'location', 'ministry'].includes(type)) resetForm(type);
                    } else {
                        // After POST, just reset the form
                        const type = cleanEndpoint === 'ministries' ? 'ministry' : cleanEndpoint.slice(0, -1);
                        if (['event', 'location', 'ministry', 'photo'].includes(type)) {
                            const form = document.getElementById(`form-add-${type}`);
                            if(form) form.reset();
                        }
                    }

                } else {
                    alert(`Error: ${result.error || 'Something went wrong'}`);
                }
            } catch (err) {
                console.error(err);
                alert("Network error occurred");
            }
        }

        async function fetchData(endpoint) {
            try {
                const res = await fetch(`/api/${endpoint}`);
                if (res.status === 403) {
                    console.warn("Session expired.");
                    return null;
                }
                if (!res.ok) throw new Error(`Failed to fetch ${endpoint}`);
                return await res.json();
            } catch (err) {
                console.error(err);
                return null;
            }
        }

        // --- Renderers ---
        function renderListItem(item) {
            const imageUrl = item.imageUrl ? `/${item.imageUrl}` : 'https://placehold.co/40x40?text=No+Image';
            return `
                <div class="current-item" data-id="${item.id}">
                    <div class="item-info">
                        <img src="${imageUrl}" alt="${item.title}">
                        <div>
                            <h3>${item.title}</h3>
                            <p>${item.subtitle || ''}</p>
                        </div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-edit" title="Edit">‚úèÔ∏è</button>
                        <button class="btn-delete" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        function renderGalleryItem(item) {
            const imageUrl = item.imageUrl ? `/${item.imageUrl}` : 'https://placehold.co/40x40?text=No+Image';
            return `
                <div class="current-item" data-id="${item.id}">
                    <div class="item-info">
                        <img src="${imageUrl}" alt="gallery">
                        <div><h3>${item.category}</h3></div>
                    </div>
                    <div class="item-actions">
                        <button class="btn-delete" title="Delete">üóëÔ∏è</button>
                    </div>
                </div>
            `;
        }

        // --- Data Loaders ---
        async function loadDynamicData(endpoint, listElementId, renderFunction) {
            const listElement = document.getElementById(listElementId);
            if (!listElement) return;
            const data = await fetchData(endpoint);
            listElement.innerHTML = data && data.length ? data.map(item => renderFunction(item)).join('') : "<p>No items found.</p>";
        }

        async function loadAboutData() {
            const data = await fetchData('about'); 
            if (!data) return;
            document.getElementById('about-mission').value = data.ourMission || '';
            document.getElementById('about-story').value = data.ourStory || '';
            if (data.imageUrl) {
                const preview = document.getElementById('about-image-preview');
                preview.src = `/${data.imageUrl}`;
                preview.style.display = 'block';
            }
        }

        // --- Submit Handlers ---
        ['event', 'location', 'ministry'].forEach(type => {
            document.getElementById(`form-add-${type}`).addEventListener('submit', (e) => {
                e.preventDefault();
                const id = document.getElementById(`${type}-id`).value;
                const method = id ? 'PUT' : 'POST';
                const url = id ? `/api/${type}s/${id}` : `/api/${type}s`;
                sendFormData(url, new FormData(e.target), method);
            });
        });

        document.getElementById('form-add-photo').addEventListener('submit', (e) => {
            e.preventDefault();
            sendFormData("/api/gallery", new FormData(e.target), 'POST');
        });

        document.getElementById('form-manage-about').addEventListener('submit', (e) => {
            e.preventDefault();
            sendFormData("/api/about", new FormData(e.target), 'PUT');
        });

        // --- Edit / Delete Logic ---
        mainContent.addEventListener('click', async (e) => {
            const editBtn = e.target.closest('.btn-edit');
            const deleteBtn = e.target.closest('.btn-delete');
            
            if (editBtn) {
                const item = e.target.closest('.current-item');
                const list = e.target.closest('.current-item-list');
                const id = item.dataset.id;
                
                let type = '';
                if (list.id === 'events-list') type = 'event';
                else if (list.id === 'locations-list') type = 'location';
                else if (list.id === 'ministries-list') type = 'ministry';

                if (type) {
                    const data = await fetchData(`${type}s/${id}`);
                    if (!data) return;

                    // Scroll to form and enter Edit Mode
                    const card = document.getElementById(`card-${type}-form`);
                    card.scrollIntoView({ behavior: 'smooth' });
                    card.classList.add('editing');
                    document.getElementById(`${type}-form-title`).textContent = `Editing: ${data.title}`;
                    document.getElementById(`${type}-submit-btn`).textContent = "Save Changes";
                    card.querySelector('.cancel-edit-btn').style.display = "inline-block";
                    
                    // Fill form fields
                    document.getElementById(`${type}-id`).value = data.id;
                    
                    const form = document.getElementById(`form-add-${type}`);
                    Object.keys(data).forEach(key => {
                        const input = form.querySelector(`[name="${key}"]`);
                        if (input && input.type !== 'file') input.value = data[key];
                    });

                    // Handle previews
                    if (data.imageUrl) {
                        const img = document.getElementById(`${type}-image-preview`);
                        img.src = `/${data.imageUrl}`;
                        img.style.display = 'block';
                    }
                    if (data.detailImageUrl) {
                        const img = document.getElementById(`${type}-detail-image-preview`);
                        if (img) {
                            img.src = `/${data.detailImageUrl}`;
                            img.style.display = 'block';
                        }
                    }
                }
            }

            if (deleteBtn) {
                if (!confirm('Are you sure you want to delete this item?')) return;
                const item = e.target.closest('.current-item');
                const list = e.target.closest('.current-item-list');
                const id = item.dataset.id;
                let endpoint = list.id === 'gallery-list' ? 'gallery' : list.id.split('-')[0];

                const res = await fetch(`/api/${endpoint}/${id}`, {
                    method: 'DELETE',
                    headers: { "Authorization": `Bearer ${token}` }
                });
                if (res.ok) {
                    item.remove();
                } else {
                    alert("Failed to delete item.");
                }
            }
        });

        // Initialize lists
        loadDynamicData('locations', 'locations-list', renderListItem);
        loadDynamicData('events', 'events-list', renderListItem);
        loadDynamicData('gallery', 'gallery-list', renderGalleryItem);
        loadDynamicData('ministries', 'ministries-list', renderListItem);
        loadAboutData(); 
    });
    </script>
</body>
</html>